version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.3.2
  aws-ecr: circleci/aws-ecr@9.5.1
  node: circleci/node@5.3.0

executors:
  python:
    docker:
      - image: cimg/python:3.11

jobs:
  mcp_quality:
    executor: python
    steps:
      - checkout
      - run:
          name: Install MCP dependencies
          command: |
            python -m pip install --upgrade pip
            cd packages/mcp-server
            pip install -e .
            pip install pytest pytest-asyncio ruff mypy
      - run:
          name: Ruff
          command: |
            cd packages/mcp-server
            ruff check .
            ruff format --check .
      - run:
          name: Mypy
          command: |
            cd packages/mcp-server
            mypy src
      - run:
          name: Pytest
          command: |
            cd packages/mcp-server
            pytest -q

  vectiqor_quality:
    executor: node/default
    steps:
      - checkout
      - run:
          name: Python compile check
          command: |
            python3 -m py_compile \
              packages/vectiqor/src/vectiqor/server.py \
              packages/vectiqor/src/vectiqor/db.py \
              packages/vectiqor/src/vectiqor/dev.py
      - run:
          name: Install pnpm
          command: corepack prepare pnpm@latest --activate
      - node/install-packages:
          pkg-manager: pnpm
          app-dir: packages/vectiqor/frontend
      - run:
          name: Build frontend
          command: |
            cd packages/vectiqor/frontend
            pnpm build

  build_python_packages:
    executor: python
    steps:
      - checkout
      - run:
          name: Build package distributions
          command: |
            python -m pip install --upgrade pip build
            mkdir -p dist/mcp-server dist/vectiqor dist/vectiqor-mcp-internal
            python -m build packages/mcp-server --outdir dist/mcp-server
            python -m build packages/vectiqor --outdir dist/vectiqor
            python -m build packages/vectiqor-mcp-internal --outdir dist/vectiqor-mcp-internal
      - persist_to_workspace:
          root: .
          paths:
            - dist
      - store_artifacts:
          path: dist

  smoke_test_python_packages:
    executor: python
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Smoke test public package
          command: |
            python -m venv /tmp/public-mcp
            /tmp/public-mcp/bin/pip install --upgrade pip
            /tmp/public-mcp/bin/pip install dist/mcp-server/*.whl
            /tmp/public-mcp/bin/finout-mcp --help
      - run:
          name: Smoke test internal package
          command: |
            python -m venv /tmp/internal-mcp
            /tmp/internal-mcp/bin/pip install --upgrade pip
            /tmp/internal-mcp/bin/pip install dist/mcp-server/*.whl dist/vectiqor-mcp-internal/*.whl
            /tmp/internal-mcp/bin/vectiqor-mcp-internal --help

  build_and_push_vectiqor_image:
    machine:
      image: ubuntu-2004:2024.05.1
    steps:
      - checkout
      - aws-ecr/build_and_push_image:
          account_id: ${AWS_ACCOUNT_ID}
          checkout: false
          create_repo: true
          dockerfile: packages/vectiqor/Dockerfile
          repo: vectiqor
          skip_when_tags_exist: false
          tag: '${CIRCLE_SHA1:0:7},${CIRCLE_BRANCH//\//-}'
          extra_build_args: "--platform=linux/amd64"
          auth:
            - aws-cli/setup:
                region: ${AWS_DEFAULT_REGION}

  tag_vectiqor_latest:
    docker:
      - image: cimg/aws:2022.06.1
    steps:
      - aws-cli/setup:
          region: ${AWS_DEFAULT_REGION}
      - aws-ecr/ecr_login
      - aws-ecr/tag_image:
          repo: vectiqor
          source_tag: "${CIRCLE_SHA1:0:7}"
          target_tag: "latest"

  publish_python_packages:
    executor: python
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Optional publish to PyPI (main only)
          command: |
            if [ "${CIRCLE_BRANCH}" != "main" ]; then
              echo "Skipping PyPI publish on non-main branch."
              exit 0
            fi
            if [ -z "${PYPI_API_TOKEN:-}" ]; then
              echo "Skipping PyPI publish (PYPI_API_TOKEN not set)."
              exit 0
            fi

            python -m pip install --upgrade pip twine
            export TWINE_USERNAME="__token__"
            export TWINE_PASSWORD="${PYPI_API_TOKEN}"
            python -m twine upload --skip-existing dist/mcp-server/*

workflows:
  ci_cd:
    jobs:
      - mcp_quality
      - vectiqor_quality
      - build_python_packages:
          requires:
            - mcp_quality
            - vectiqor_quality
      - smoke_test_python_packages:
          requires:
            - build_python_packages
      - build_and_push_vectiqor_image:
          context: finout
          requires:
            - smoke_test_python_packages
      - tag_vectiqor_latest:
          context: finout
          requires:
            - build_and_push_vectiqor_image
          filters:
            branches:
              only: main
      - publish_python_packages:
          requires:
            - smoke_test_python_packages
